<link rel="import" href="./todo-app-toolbar.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="./todo-swipeable-card.html">
<link rel="import" href="./todo-task.html">

<!--
# `<todo-project-view>`

@demo demo/todo-project-view.html
-->
<dom-module id="todo-project-view">
  <template>
    <style>
      :host {
        position:relative;
        display: block;
        @apply(--fullbleed);
        @apply(--layout-vertical);
      }
      todo-task {
        border:1px solid lightgray;
      }
      todo-task[done] {
        background: rgb(178, 191, 197);
      }
      paper-fab {
        position: absolute;
        bottom: 20px;
        right: 20px;
      }
      .tasks-list {
        flex: 1;
        padding-bottom: 80px;
        overflow-y: auto;
        overflow-x: hidden;
      }
      #newtask {
        position: absolute;
        top:0;
        left:0;
        right:0;
        background: white;
        padding:10px;
        transition: 0.3s ease-in-out;
        box-shadow:0px 5px 25px darkgray;
        overflow: auto;
        /* 100% minus paddings */
        max-height: calc(100% - 20px);
      }
      #newtask.hidden {
        transform: translateY(-250px);
      }
      #view {
        position:relative;
        flex:1;
        overflow:hidden;
        display: flex;
        flex-direction: column;
      }
      .control {
        text-align: right;
      }
    </style>
    <todo-app-toolbar label={{project.name}}></todo-app-toolbar>
    <div id="view" >

    <div class="tasks-list">
      <template id="list" is="dom-repeat" items="{{project.tasks}}">
        <todo-swipeable-card undo-timeout=1000 disabled={{item.done}}
                on-iron-swipe="_todoAction" >
          <todo-task task={{item}} ></todo-task>
        </todo-swipeable-card>
      </template>
      <paper-fab icon="add" on-tap="_newTaskForm"></paper-fab>
    </div>

    <div id="newtask" class="hidden">
      <form is="iron-form" id="form">
        <paper-input label="label" value="{{_newTask.label}}"></paper-input>
        <div class="layout horizontal">
          <paper-input label="due date" value="{{_newTask.dueDate}}"></paper-input>
          <paper-input label="planned time"  value="{{_newTask.planned}}"></paper-input>
        </div>
      </form>
      <div class="control">
        <paper-button class="secondary" on-tap="_close">Cancel</paper-button>
        <paper-button class="primary" on-tap="_save">Save</paper-button>
      </div>
    </div>
  </div>
  </template>
  <script>
    Polymer({
      is: 'todo-project-view',

      properties: {
        project: {
          type: Object,
          notify: true,
          observer: "_projectChanged"
        },
        _newTask: {
          type: Object,
        },
        _selected: {
          type: Number,
          value: null
        },
      },

      _projectChanged: function() {
        let _isRunning = task => task.state==="running";

        this.current = this.project.tasks.filter(_isRunning)[0];
      },

      _newTaskForm: function() {
        this._newTask = {};
        this.$.newtask.classList.toggle("hidden");
        this.$.form.querySelector('paper-input').$.input.focus();
      },

      _close: function() {
        this.$.form.reset();
        if(!this.$.newtask.classList.contains("hidden")) {
          this.$.newtask.classList.add("hidden")
        }
      },

      _save: function() {
        if(this._newTask.label) {
          let newTask = Object.assign(this._newTask, { status:"pending", consummed:0});
          this.push('project.tasks', newTask);
        }
        this._close()
      },

      _todoAction: function(evt) {
        // console.log(evt.detail, evt.model.item);
        switch (evt.detail.direction) {
          case 'done':
            this.push('project.done', evt.model.item);
            this.splice('project.tasks', evt.model.index, 1);
            break;
          case 'delete':
            this.splice('project.tasks', evt.model.index, 1);
            break;
        }
      },

      _isRunning: function(item) {
        return item.state==='running';
      },

      _stop: function(evt) {

      },

      _pause: function(evt) {

      },

      _start: function(evt) {

      },
    });
  </script>
</dom-module>
